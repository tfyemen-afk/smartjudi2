"""Compatibility helpers for object copying and replacement.

Provides a minimal `replace` function used by migration utilities.
This is a lightweight shim to restore missing functionality in the
installed Django package; installing a full, correct Django release is
the recommended fix.
"""
from __future__ import annotations

from copy import copy as _shallow_copy
from typing import Any


def replace(obj: Any, **changes: Any) -> Any:
    """Return a shallow copy of ``obj`` with attributes/items replaced.

    - For objects with `_replace` (e.g., namedtuple) call that method.
    - For mappings, return a shallow copy updated with `changes`.
    - For regular objects, set attributes on a shallow copy.
    """
    if not changes:
        return _shallow_copy(obj)

    # namedtuple-like
    if hasattr(obj, "_replace"):
        try:
            return obj._replace(**changes)  # type: ignore[attr-defined]
        except Exception:
            pass

    # mappings
    try:
        mapping_copy = dict(obj)  # works for dict-like
    except Exception:
        mapping_copy = None

    if mapping_copy is not None:
        mapping_copy.update(changes)
        return mapping_copy

    # generic object: shallow copy and set attributes
    new = _shallow_copy(obj)
    for key, val in changes.items():
        try:
            setattr(new, key, val)
        except Exception:
            # ignore attributes we cannot set
            pass
    return new


__all__ = ["replace"]
