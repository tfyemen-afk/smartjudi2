"""Minimal CSP middleware shim for local development.

Provides `get_nonce` and a `ContentSecurityPolicyMiddleware` so code
that imports `django.middleware.csp` can run when the installed
Django build lacks this module. This is a compatibility shim only;
use a proper Django release for full CSP support.
"""
from __future__ import annotations

import secrets
from typing import Optional

from django.conf import settings


def _generate_nonce() -> str:
    # URL-safe token suitable for CSP nonces
    return secrets.token_urlsafe(16)


def get_nonce(request) -> Optional[str]:
    """Return the CSP nonce for the given request, if present."""
    return getattr(request, "_csp_nonce", None)


class ContentSecurityPolicyMiddleware:
    """Middleware that ensures a per-request CSP nonce exists.

    This middleware does not enforce any policy by itself; it only
    generates a nonce and attaches it to the request so templates and
    other middleware can access it via `get_nonce(request)`.
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # attach nonce if not present
        if not hasattr(request, "_csp_nonce") or request._csp_nonce is None:
            request._csp_nonce = _generate_nonce()

        response = self.get_response(request)

        # Optionally add a very permissive CSP header if configured; keep
        # minimal to avoid breaking pages during development.
        if getattr(settings, "CSP_ADD_HEADER", False):
            # default to allowing nonce in script-src if no custom header
            policy = getattr(settings, "CSP_POLICY", "script-src 'nonce-" + request._csp_nonce + "'")
            response.setdefault("Content-Security-Policy", policy)

        return response


__all__ = ["get_nonce", "ContentSecurityPolicyMiddleware"]
